<html>

<head>
    <title>My First Web Page</title>
    <script>
        loadQueryParams = function() {
            var params = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                params[pair[0]] = decodeURIComponent(pair[1]);
            }
            return params;
        }
        window.params = loadQueryParams();
    </script>
    <script src="dist/bundle.js"></script>
</head>

<body>
<p id="currentChord"></p>
<div style="margin-top: 3rem; display: flex; justify-content: space-between; padding: 1rem 5rem; border: 1px solid black; flex-wrap: wrap;">
    <div>
        <label for="cadence-count">Sointukulkujen määrä</label>
        <input type="number" id="cadence-count" value="2" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="bars-per-cadence">Sointukulkujen pituus</label>
        <input type="number" id="bars-per-cadence" value="4" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="base-tension">Vaikeusaste</label>
        <input type="number" id="base-tension" value="0.3" min="-10" max="10" step="0.1" style="width: 100px">
    </div>
    <div>
        <label for="tempo">Tempo</label>
        <input type="number" id="tempo" value="40" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="half-notes">Puolinuotit</label>
        <input type="checkbox" id="half-notes" style="width: 100px">
    </div>
    <div>
        <label for="sixteenth-notes">16-osien osuus</label>
        <input type="number" id="sixteenth-notes" value="0.5" min="0" max="1" step="0.1" style="width: 100px">
    </div>
    <div>
        <h4>Soinnut</h4>
        <div>
            <label for="chord-maj">Maj</label>
            <input type="checkbox" id="chord-maj" value="maj">
        </div>
        <div>
            <label for="chord-min">Min</label>
            <input type="checkbox" id="chord-min" value="min">
        </div>
        <div>
            <label for="chord-aug">Aug</label>
            <input type="checkbox" id="chord-aug" value="aug">
        </div>
        <div>
            <label for="chord-dim">Dim</label>
            <input type="checkbox" id="chord-dim" value="dim">
        </div>
        <div>
            <label for="chord-maj7">Maj7</label>
            <input type="checkbox" id="chord-maj7" value="maj7">
        </div>
        <div>
            <label for="chord-dom7">Dom7</label>
            <input type="checkbox" id="chord-dom7" value="dom7">
        </div>
        <div>
            <label for="chord-sus2">sus2</label>
            <input type="checkbox" id="chord-sus2" value="sus2">
        </div>
        <div>
            <label for="chord-sus4">sus4</label>
            <input type="checkbox" id="chord-sus4" value="sus4">
        </div>
    </div>
    <div>
        <label for="note-p1">Lähtösävel</label>
        <input id="note-p1" type="text" value="E5" style="width: 100px">
        <label for="voice-p1">Ääni</label>
        <input id="voice-p1" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p2">Lähtösävel</label>
        <input id="note-p2" type="text" value="E4" style="width: 100px">
        <label for="voice-p2">Ääni</label>
        <input id="voice-p2" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p3">Lähtösävel</label>
        <input id="note-p3" type="text" value="C4" style="width: 100px">
        <label for="voice-p3">Ääni</label>
        <input id="voice-p3" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p4">Lähtösävel</label>
        <input id="note-p4" type="text" value="C3" style="width: 100px">
        <label for="voice-p4">Ääni</label>
        <input id="voice-p4" type="number" step="1"></input>
    </div>
    <div>
        <button onclick="updateParamsFromSettings()">OK</button>
    </div>
</div>
<button id="btn-play">PLAY</button>
<button id="btn-pause">PAUSE</button>
<button id="btn-stop">STOP</button>
<div id="score"></div>
<div id="loading">loading...</div>

</body>
<script>

    const beatMS = 3000;
    const beep = (freq = 320, duration = 100, vol = 5) => {
        const oscillator = context.createOscillator();
        const gain = context.createGain();
        oscillator.connect(gain);
        oscillator.frequency.value = freq;
        oscillator.type = "square";
        gain.connect(context.destination);
        gain.gain.value = vol * 0.01;
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + duration * 0.001);
    }
    const playChord = (notes, length, volMultiplier) => {
        context = new AudioContext();
        volMultiplier = volMultiplier || 1;
        return new Promise((resolve) => {
            let index = 0
            for (const note of notes) {
                const freq = note
                let vol = 2;
                if (index == 0) {
                    vol = 5
                }
                if (index == 2) {
                    vol = 5
                }
                beep(freq, length, vol * volMultiplier)
                index++;
            }
            setTimeout(resolve, length)
        })
    }
    const runChords = async function() {
        let i = 0;
        for (const chord of window.chords) {
            document.querySelector("#currentChord").innerHTML = `${window.result[i].chord.toString()} (${window.result[i].tension.toFixed(2)})`
            await playChord(chord, beatMS)
            i++;
        }
    }
    const playMelody = async function() {
        for (const tick in window.melody) {
            setTimeout(() => {
                const note = window.melody[tick]
                if (note) {
                    beep(note.freq, beatMS / 12 * note.duration, 7)
                }
            }, beatMS / 12 * tick)
        }
    }
    const updateSettingsFromParams = () => {
        const params = window.params;
        if (params.cadenceCount) {
            document.querySelector("#cadence-count").value = params.cadenceCount;
        }
        if (params.barsPerCadence) {
            document.querySelector("#bars-per-cadence").value = params.barsPerCadence;
        }
        if (params.baseTension) {
            document.querySelector("#base-tension").value = params.baseTension;
        }
        if (params.tempo) {
            document.querySelector("#tempo").value = params.tempo;
        }
        if (params.chords) {
            let chords = params.chords;
            if (typeof chords === "string") {
                chords = chords.split(",");
            }
            for (const chord of chords) {
                (document.querySelector(`#chord-${chord}`) || {}).checked = true;
            }
        }
        if (params.halfNotes) {
            document.querySelector("#half-notes").checked = params.halfNotes;
        }
        if (params.sixteenthNotes) {
            document.querySelector("#sixteenth-notes").value = params.sixteenthNotes;
        }
        if (params.voiceP1) {
            document.querySelector("#voice-p1").value = params.voiceP1;
        }
        if (params.voiceP2) {
            document.querySelector("#voice-p2").value = params.voiceP2;
        }
        if (params.voiceP3) {
            document.querySelector("#voice-p3").value = params.voiceP3;
        }
        if (params.voiceP4) {
            document.querySelector("#voice-p4").value = params.voiceP4;
        }
        if (params.noteP1) {
            document.querySelector("#note-p1").value = params.noteP1;
        }
        if (params.noteP2) {
            document.querySelector("#note-p2").value = params.noteP2;
        }
        if (params.noteP3) {
            document.querySelector("#note-p3").value = params.noteP3;
        }
        if (params.noteP4) {
            document.querySelector("#note-p4").value = params.noteP4;
        }
    }
    updateSettingsFromParams();

    const updateParamsFromSettings = () => {
        const params = window.params;
        params.cadenceCount = document.querySelector("#cadence-count").value;
        params.barsPerCadence = document.querySelector("#bars-per-cadence").value;
        params.baseTension = document.querySelector("#base-tension").value;
        params.tempo = document.querySelector("#tempo").value;
        const chords = [];
        for (const chord of document.querySelectorAll("input[type=checkbox]:checked")) {
            chords.push(chord.value);
        }
        params.chords = chords.join(",");
        params.halfNotes = document.querySelector("#half-notes").checked;
        params.sixteenthNotes = document.querySelector("#sixteenth-notes").value;
        params.voiceP1 = document.querySelector("#voice-p1").value;
        params.voiceP2 = document.querySelector("#voice-p2").value;
        params.voiceP3 = document.querySelector("#voice-p3").value;
        params.voiceP4 = document.querySelector("#voice-p4").value;
        params.noteP1 = document.querySelector("#note-p1").value;
        params.noteP2 = document.querySelector("#note-p2").value;
        params.noteP3 = document.querySelector("#note-p3").value;
        params.noteP4 = document.querySelector("#note-p4").value;

        // create url from params and follow the link
        const url = new URL(window.location.href);
        url.search = new URLSearchParams(params).toString();
        window.location.href = url;
    }

    //console.log(window.scoreXML)

</script>

</html>