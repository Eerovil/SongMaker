<html>

<head>
    <title>My First Web Page</title>
    <script>
        loadQueryParams = function() {
            var params = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                params[pair[0]] = decodeURIComponent(pair[1]);
            }
            if (params.fulldata) {
                return JSON.parse(params.fulldata);
            }
            return params;
        }
        window.params = loadQueryParams();
    </script>
    <script src="dist/bundle.js"></script>
    <style>
        #beatsettings input[type="range"] {
           appearance: slider-vertical;
           width: 1rem;
        }
        #beatsettings {
            display: flex;
        }
        .beatsetting {
            display: flex;
            flex-direction: column;
        }
        .beatsetting:nth-child(4n) {
            margin-right: 1rem;
        }
    </style>
</head>

<body>
<p id="currentChord"></p>
<div style="margin-top: 3rem; display: flex; justify-content: space-between; padding: 1rem 5rem; border: 1px solid black; flex-wrap: wrap;">
    <div style="width: 100%; display: flex;">
    <div>
        <label for="cadence-count">Sointukulkujen määrä</label>
        <input type="number" id="cadence-count" value="2" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="bars-per-cadence">Sointukulkujen pituus</label>
        <input type="number" id="bars-per-cadence" value="4" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="base-tension">Vaikeusaste</label>
        <input type="number" id="base-tension" value="0.3" min="-10" max="10" step="0.1" style="width: 100px" onchange="changeBaseTension()">
    </div>
    <div>
        <label for="tempo">Tempo</label>
        <input type="number" id="tempo" value="40" min="1" max="300" step="1" style="width: 100px">
    </div>
    <div>
        <label for="half-notes">Puolinuotit</label>
        <input type="checkbox" id="half-notes" style="width: 100px">
    </div>
    <div>
        <label for="sixteenth-notes">16-osien osuus</label>
        <input type="number" id="sixteenth-notes" value="0.5" min="0" max="1" step="0.1" style="width: 100px">
    </div>
    <div>
        <label for="scale-template">Asteikko</label>
        <select id="scale-template"></select>
    </div>
    <div>
        <h4>Soinnut</h4>
        <div>
            <label for="chord-maj">Maj</label>
            <input type="checkbox" class="chordbox" id="chord-maj" value="maj">
            <input type="range" id="chord-maj-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-min">Min</label>
            <input type="checkbox" class="chordbox" id="chord-min" value="min">
            <input type="range" id="chord-min-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-aug">Aug</label>
            <input type="checkbox" class="chordbox" id="chord-aug" value="aug">
            <input type="range" id="chord-aug-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-dim">Dim</label>
            <input type="checkbox" class="chordbox" id="chord-dim" value="dim">
            <input type="range" id="chord-dim-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-maj7">Maj7</label>
            <input type="checkbox" class="chordbox" id="chord-maj7" value="maj7">
            <input type="range" id="chord-maj7-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-dom7">Dom7</label>
            <input type="checkbox" class="chordbox" id="chord-dom7" value="dom7">
            <input type="range" id="chord-dom7-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-sus2">sus2</label>
            <input type="checkbox" class="chordbox" id="chord-sus2" value="sus2">
            <input type="range" id="chord-sus2-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
        <div>
            <label for="chord-sus4">sus4</label>
            <input type="checkbox" class="chordbox" id="chord-sus4" value="sus4">
            <input type="range" id="chord-sus4-weight" value="1" min="-0.5" max="0" step="0.1">
        </div>
    </div>
    </div>
    <div>
        <label for="note-p1">Lähtösävel</label>
        <input id="note-p1" type="text" value="E5" style="width: 100px">
        <label for="voice-p1">Ääni</label>
        <input id="voice-p1" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p2">Lähtösävel</label>
        <input id="note-p2" type="text" value="E4" style="width: 100px">
        <label for="voice-p2">Ääni</label>
        <input id="voice-p2" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p3">Lähtösävel</label>
        <input id="note-p3" type="text" value="C4" style="width: 100px">
        <label for="voice-p3">Ääni</label>
        <input id="voice-p3" type="number" step="1"></input>
    </div>
    <div>
        <label for="note-p4">Lähtösävel</label>
        <input id="note-p4" type="text" value="C3" style="width: 100px">
        <label for="voice-p4">Ääni</label>
        <input id="voice-p4" type="number" step="1"></input>
    </div>
    <div>
        <button onclick="updateParamsFromSettings()">OK</button>
        <button onclick="window.location.href = '/'">Reset</button>
    </div>
    <div style="width: 100%" id="beatsettings">

    </div>
</div>
<button id="btn-play">PLAY</button>
<button id="btn-pause">PAUSE</button>
<button id="btn-stop">STOP</button>
<div id="score"></div>
<div id="loading">loading...</div>

</body>
<script>

    const beatMS = 3000;
    const beep = (freq = 320, duration = 100, vol = 5) => {
        const oscillator = context.createOscillator();
        const gain = context.createGain();
        oscillator.connect(gain);
        oscillator.frequency.value = freq;
        oscillator.type = "square";
        gain.connect(context.destination);
        gain.gain.value = vol * 0.01;
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + duration * 0.001);
    }
    const playChord = (notes, length, volMultiplier) => {
        context = new AudioContext();
        volMultiplier = volMultiplier || 1;
        return new Promise((resolve) => {
            let index = 0
            for (const note of notes) {
                const freq = note
                let vol = 2;
                if (index == 0) {
                    vol = 5
                }
                if (index == 2) {
                    vol = 5
                }
                beep(freq, length, vol * volMultiplier)
                index++;
            }
            setTimeout(resolve, length)
        })
    }
    const runChords = async function() {
        let i = 0;
        for (const chord of window.chords) {
            document.querySelector("#currentChord").innerHTML = `${window.result[i].chord.toString()} (${window.result[i].tension.toFixed(2)})`
            await playChord(chord, beatMS)
            i++;
        }
    }
    const playMelody = async function() {
        for (const tick in window.melody) {
            setTimeout(() => {
                const note = window.melody[tick]
                if (note) {
                    beep(note.freq, beatMS / 12 * note.duration, 7)
                }
            }, beatMS / 12 * tick)
        }
    }
    const updateSettingsFromParams = () => {
        const params = window.params;
        if (params.cadenceCount) {
            document.querySelector("#cadence-count").value = params.cadenceCount;
        }
        if (params.barsPerCadence) {
            document.querySelector("#bars-per-cadence").value = params.barsPerCadence;
        }
        if (params.baseTension) {
            document.querySelector("#base-tension").value = params.baseTension;
        }
        if (params.tempo) {
            document.querySelector("#tempo").value = params.tempo;
        }
        if (params.chords) {
            let chords = params.chords;
            if (typeof chords === "string") {
                chords = chords.split(",");
            }
            let i=-1;
            for (const chord of chords) {
                i++;
                (document.querySelector(`#chord-${chord}`) || {}).checked = true;
                const setting = params.chordSettings[i];
                (document.querySelector(`#chord-${chord}-weight`) || {}).value = (setting || {}).weight || 0;
            }
        }
        if (params.halfNotes) {
            document.querySelector("#half-notes").checked = params.halfNotes;
        }
        if (params.sixteenthNotes) {
            document.querySelector("#sixteenth-notes").value = params.sixteenthNotes;
        }

        for (let i=0; i<4; i++) {
            const voiceParam = params.parts[i];
            const voice = voiceParam.voice;
            const note = voiceParam.note;
            const voiceInput = document.querySelector(`#voice-p${i+1}`);
            const noteInput = document.querySelector(`#note-p${i+1}`);
            if (voiceInput) {
                voiceInput.value = voice;
            }
            if (noteInput) {
                noteInput.value = note;
            }
        }
        const beatCount = params.barsPerCadence * params.cadenceCount * 4;
        const beatSettingWrapper = document.querySelector("#beatsettings");
        for (let i=0; i<beatCount; i++) {
            const el = document.createElement("div");
            el.classList.add("beatsetting");
            const beatSetting = params.beatSettings[i];
            let tension = params.baseTension;
            if (beatSetting) {
                tension = beatSetting.tension;
            }
            el.innerHTML = `
                <label for="beat-${i}">${i}</label>
                <input id="beat-${i}" type="range" step="0.1" min="-1" max="1" value="${tension}">
            `;
            beatSettingWrapper.appendChild(el);
        }

        const scaleTemplateSelect = document.querySelector("#scale-template");
        for (const scaleTemplateChoice of window.scaleTemplateChoices) {
            const option = document.createElement("option");
            option.value = scaleTemplateChoice;
            option.innerHTML = scaleTemplateChoice;
            scaleTemplateSelect.appendChild(option);
        }
        if (params.scaleTemplate) {
            scaleTemplateSelect.value = params.scaleTemplate;
        }

    }
    updateSettingsFromParams();

    const updateParamsFromSettings = () => {
        const params = window.params;
        params.cadenceCount = document.querySelector("#cadence-count").value;
        params.barsPerCadence = document.querySelector("#bars-per-cadence").value;
        params.baseTension = document.querySelector("#base-tension").value;
        params.tempo = document.querySelector("#tempo").value;
        const chords = [];
        for (const chord of document.querySelectorAll("input.chordbox[type=checkbox]:checked")) {
            chords.push(chord.value);
        }
        params.chords = chords;
        params.halfNotes = document.querySelector("#half-notes").checked;
        params.sixteenthNotes = document.querySelector("#sixteenth-notes").value;

        const voices = [];
        for (const voice of [1, 2, 3, 4]) {
            const voiceInput = document.querySelector(`#voice-p${voice}`) || "1";
            const noteInput = document.querySelector(`#note-p${voice}`);
            voices.push({
                voice: voiceInput.value,
                note: noteInput.value
            });
        }
        params.parts = voices;

        const beatSettings = [];
        for (const beatSetting of document.querySelectorAll(".beatsetting")) {
            const tension = beatSetting.querySelector("input").value;
            beatSettings.push({
                tension
            });
        }
        params.beatSettings = beatSettings;

        const chordSettings = [];
        for (const chord of params.chords) {
            const weight = document.querySelector(`#chord-${chord}-weight`).value;
            chordSettings.push({
                weight
            });
        }
        params.chordSettings = chordSettings;

        params.scaleTemplate = document.querySelector("#scale-template").value;

        // create url from params and follow the link
        const url = new URL(window.location.href);
        const searchParams = new URLSearchParams();

        searchParams.set("fulldata", JSON.stringify(params));

        url.search = searchParams.toString();
        window.location.href = url;
    }

    const changeBaseTension = () => {
        const oldBaseTension = window.params.baseTension;
        const newBaseTension = document.querySelector("#base-tension").value;
        const beatSettings = window.params.beatSettings;
        for (let i=0; i<beatSettings.length; i++) {
            const beatSetting = beatSettings[i];
            if (beatSetting.tension === oldBaseTension) {
                beatSetting.tension = newBaseTension;
                document.querySelector(`#beat-${i}`).value = newBaseTension;
            }
        }
        window.params.baseTension = newBaseTension;
    }

    //console.log(window.scoreXML)

</script>

</html>