<html>

<head>
    <title>My First Web Page</title>
    <script src="dist/bundle.js"></script>
</head>

<body>
<p id="currentChord"></p>
<button onclick="playMusic()">PLAY</button>
</body>
<script>
    const beatMS = 3000;
    const beep = (freq = 320, duration = 100, vol = 5) => {
        const oscillator = context.createOscillator();
        const gain = context.createGain();
        oscillator.connect(gain);
        oscillator.frequency.value = freq;
        oscillator.type = "square";
        gain.connect(context.destination);
        gain.gain.value = vol * 0.01;
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + duration * 0.001);
    }
    const playChord = (notes, length, volMultiplier) => {
        context = new AudioContext();
        volMultiplier = volMultiplier || 1;
        return new Promise((resolve) => {
            let index = 0
            for (const note of notes) {
                const freq = note
                let vol = 2;
                if (index == 0) {
                    vol = 5
                }
                if (index == 2) {
                    vol = 5
                }
                beep(freq, length, vol * volMultiplier)
                index++;
            }
            setTimeout(resolve, length)
        })
    }
    const runChords = async function() {
        let i = 0;
        for (const chord of window.chords) {
            document.querySelector("#currentChord").innerHTML = `${window.result[i].chord.toString()} (${window.result[i].tension.toFixed(2)})`
            await playChord(chord, beatMS)
            i++;
        }
    }
    const playMelody = async function() {
        for (const tick in window.melody) {
            setTimeout(() => {
                const note = window.melody[tick]
                if (note) {
                    beep(note.freq, beatMS / 12 * note.duration, 7)
                }
            }, beatMS / 12 * tick)
        }
    }
    window.playMusic = () => {
        runChords();
        playMelody();
    }
</script>

</html>